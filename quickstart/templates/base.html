<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}SIREDO-TUS{% endblock %}</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/lecturer.css') }}" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
    <nav class="navbar bg-danger">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center gap-2" href="/" style="font-family: 'Georgia', serif; font-size: 24px; color: white;">
                <img src="/static/assets/img/telkom.webp" alt="Logo" width="40" height="36"><span>Research Recommender System</span>
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row align-items-center" style="position: relative;">
                <a class="nav-link text-white me-3" href="/">Home</a>
                <a class="nav-link text-white" href="/lecturers">Lecturers</a>
                <button id="approachToggle" type="button" class="btn btn-danger btn-sm ms-2 d-flex align-items-center justify-content-center" title="Pengaturan Pendekatan" aria-label="Pengaturan Pendekatan" aria-expanded="false" style="width:36px;height:36px;border-radius:50%;background-color:#dc3545;border-color:#dc3545;color:#ffffff;">
                    <i class="bi-gear" style="pointer-events: none; color: #ffffff;"></i>
                </button>
                <!-- Panel pengaturan pendekatan (dropdown) -->
                <div id="approachPanel" class="card shadow-sm" style="position: absolute; right: 0; top: 48px; width: 260px; display: none; z-index: 1060;">
                    <div class="card-body py-2">
                        <label for="approachSelect" class="form-label mb-1">Approach</label>
                        <select class="form-select form-select-sm" id="approachSelect">
                            <option value="hybrid" selected>Hybrid (Naive Bayes) </option>
                            <option value="onevsrest">One-vs-Rest</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Block content untuk konten halaman -->
     <div class="container-fluid my-0 px-0">
        {% block content %}
        {% endblock %}
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const formSearch = document.querySelector('.form-search');
            if (!formSearch) return; 

            const CARDS_PER_PAGE = 6;
            let currentResults = [];
            let currentPage = 1;

            // Toggle panel pendekatan
            const approachToggle = document.getElementById('approachToggle');
            const approachPanel = document.getElementById('approachPanel');
            if (approachToggle && approachPanel) {
                function setPanelVisible(show) {
                    approachPanel.style.display = show ? 'block' : 'none';
                    approachToggle.setAttribute('aria-expanded', show ? 'true' : 'false');
                }

                approachToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const isShown = approachPanel.style.display !== 'none';
                    setPanelVisible(!isShown);
                });

                approachToggle.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        e.stopPropagation();
                        const isShown = approachPanel.style.display !== 'none';
                        setPanelVisible(!isShown);
                    }
                });

                // Klik di luar panel atau tombol -> tutup
                document.addEventListener('click', function(e) {
                    const clickOnToggle = approachToggle.contains(e.target);
                    const clickInsidePanel = approachPanel.contains(e.target);
                    if (!clickOnToggle && !clickInsidePanel) {
                        setPanelVisible(false);
                    }
                });
            }

            function createCard(lecture, score, department, expertise, showScore, code) {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-4';

                col.innerHTML = `
                <div class="card mb-2 h-100" style="max-width: 550px;">
                    <div class="row g-0 align-items-stretch h-100">
                        <div class="col-md-4 d-flex flex-column align-items-center justify-content-start mt-4">
                            <img src="/static/assets/img/person.png" class="img-fluid rounded-circle mb-4" alt="${lecture}" style="width: 100px; height: 100px; object-fit: cover;">
                            <a href="/profile/${encodeURIComponent(code || lecture)}" class="btn btn-outline-success mt-3" style="width: 95px">View Profile</a>
                        </div>
                        <div class="col-md-8 d-flex">
                            <div class="card-body p-3">
                                <h6 class="card-title mb-2">${lecture}</h6>
                                ${showScore ? `<div class="mb-2"><span class="badge bg-success">Accuration: ${(score * 100).toFixed(1)}%</span></div>` : ''}
                                <hr>
                                <p class="card-text mb-1 small">Department:<br><strong>${department}</strong></p>
                                <hr>
                                <p class="card-text mb-1 small expertise-list">Expertise:<br>${expertise}</p>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                return col;
            }


            function displayCards(page = 1) {
                const cardContainer = document.getElementById('cardContainer');
                const paginationContainer = document.getElementById('paginationContainer');
                const startIdx = (page - 1) * CARDS_PER_PAGE;
                const endIdx = startIdx + CARDS_PER_PAGE;
                const cardsToShow = currentResults.slice(startIdx, endIdx);

                if (page === 1) {
                    cardContainer.innerHTML = '';
                }

                // Add new cards
                cardsToShow.forEach(result => {
                    const card = createCard(result.lecture, result.score, result.department, result.expertise);
                    cardContainer.appendChild(card);
                });

                // Show/hide pagination
                paginationContainer.style.display = currentResults.length > page * CARDS_PER_PAGE ? 'block' : 'none';
            }

            formSearch.addEventListener('submit', async function(e) {
                e.preventDefault();

                const input = document.getElementById('text');
                const kataKunci = input.value.trim();
                const selectedApproach = (document.getElementById('approachSelect')?.value || 'hybrid');
                if (!kataKunci) {
                    alert('Masukkan kata kunci dulu ya!');
                    return;
                }

                const cardContainer = document.getElementById('cardContainer');
                cardContainer.innerHTML = '<div class="col-12 text-center">Loading...</div>';
                document.getElementById('resultSection').style.display = 'block';

                try {
                    const response = await fetch('/rekomendasi', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            kata_kunci: kataKunci,
                            approach: selectedApproach
                        })
                    });
                    const data = await response.json();

                    if (data.error) {
                        cardContainer.innerHTML = `<div class="col-12 text-center">${data.error}</div>`;
                    } else if (data.results && data.results.length > 0) {
                        currentResults = data.results;
                        currentPage = 1;
                        // Render pertama dengan flag showScore jika One-vs-Rest
                        const showScore = selectedApproach === 'onevsrest' || selectedApproach === 'ovr';
                        const cardContainerEl = document.getElementById('cardContainer');
                        cardContainerEl.innerHTML = '';
                        const toShow = currentResults.slice(0, CARDS_PER_PAGE);
                        toShow.forEach(result => {
                            const card = createCard(result.lecture, result.score, result.department, result.expertise, showScore, result.code_lec);
                            cardContainerEl.appendChild(card);
                        });
                        const paginationContainer = document.getElementById('paginationContainer');
                        paginationContainer.style.display = currentResults.length > CARDS_PER_PAGE ? 'block' : 'none';
                        // Simpan flag di dataset untuk 'See More'
                        paginationContainer.dataset.showScore = showScore ? '1' : '0';
                    } else {
                        cardContainer.innerHTML = `
                            <div class="col-12 text-center">
                                <p>${data.message}</p>
                                <p>Tidak ada rekomendasi ditemukan.</p>
                            </div>`;
                    }
                } catch (err) {
                    cardContainer.innerHTML = `<div class="col-12 text-center">Error: ${err.message}</div>`;
                }
            });

            // Event listener for "Lihat Selengkapnya" button
            document.getElementById('showMoreBtn').addEventListener('click', function() {
                currentPage++;
                const cardContainer = document.getElementById('cardContainer');
                const paginationContainer = document.getElementById('paginationContainer');
                const showScore = paginationContainer.dataset.showScore === '1';
                const startIdx = (currentPage - 1) * CARDS_PER_PAGE;
                const endIdx = startIdx + CARDS_PER_PAGE;
                const cardsToShow = currentResults.slice(startIdx, endIdx);
                cardsToShow.forEach(result => {
                    const card = createCard(result.lecture, result.score, result.department, result.expertise, showScore, result.code_lec);
                    cardContainer.appendChild(card);
                });
                paginationContainer.style.display = currentResults.length > currentPage * CARDS_PER_PAGE ? 'block' : 'none';
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
